import { generateVulnerabilityGithubIssueBody, generateVulnerabilityGithubIssueTasks, Vulnerability } from './index'

it('generateVulnerabilityGithubIssueBody', () => {
  expect(generateVulnerabilityGithubIssueBody(exampleVulnerability)).toEqual([
    { type: 'text', text: '## Overview' },
    { type: 'text', text: '' },
    { type: 'text', text: 'ID: CVE-0' },
    { type: 'text', text: 'Severity: CRITICAL' },
    { type: 'text', text: 'V3Vector: CVSS:3.1' },
    { type: 'text', text: 'V3Score: 10.0' },
    { type: 'text', text: '' },
    { type: 'text', text: '## Locations' },
    { type: 'text', text: '' },
    {
      type: 'task',
      label: 'artifact `alpine`, package `lib` (`alpine:3.15/lib@1.0.0`, `alpine:3.16/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'alpine/lib' },
    },
    {
      type: 'task',
      label: 'artifact `busybox`, package `lib` (`busybox:1.1/lib@1.0.0`, `busybox:1.2/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'busybox/lib' },
    },
    { type: 'text', text: '' },
    { type: 'text', text: '## Details' },
    { type: 'text', text: '' },
    { type: 'text', text: 'Description' },
    { type: 'text', text: '' },
    { type: 'text', text: '## References' },
    { type: 'text', text: '' },
    { type: 'text', text: '* https://link1' },
    { type: 'text', text: '* https://link2' },
    { type: 'text', text: '' },
    { type: 'text', text: '---' },
    { type: 'text', text: '' },
    { type: 'text', text: '123' },
  ])
})

it('generateVulnerabilityGithubIssueTasks', () => {
  expect(generateVulnerabilityGithubIssueTasks(exampleVulnerability)).toEqual([
    {
      type: 'task',
      label: 'artifact `alpine`, package `lib` (`alpine:3.15/lib@1.0.0`, `alpine:3.16/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'alpine/lib' },
    },
    {
      type: 'task',
      label: 'artifact `busybox`, package `lib` (`busybox:1.1/lib@1.0.0`, `busybox:1.2/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'busybox/lib' },
    },
  ])

  expect(
    generateVulnerabilityGithubIssueTasks(exampleVulnerability, {
      body: '- [x] old <!-- location-id=busybox/lib -->',
    } as any)
  ).toEqual([
    {
      type: 'task',
      label: 'artifact `alpine`, package `lib` (`alpine:3.15/lib@1.0.0`, `alpine:3.16/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'alpine/lib' },
    },
    {
      type: 'task',
      label: 'artifact `busybox`, package `lib` (`busybox:1.1/lib@1.0.0`, `busybox:1.2/lib@1.1.0`)',
      done: true,
      params: { 'location-id': 'busybox/lib' },
    },
  ])

  expect(
    generateVulnerabilityGithubIssueTasks(exampleVulnerability, {
      body: '- [ ] other <!-- location-id=other -->',
    } as any)
  ).toEqual([
    {
      type: 'task',
      label: 'artifact `alpine`, package `lib` (`alpine:3.15/lib@1.0.0`, `alpine:3.16/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'alpine/lib' },
    },
    {
      type: 'task',
      label: 'artifact `busybox`, package `lib` (`busybox:1.1/lib@1.0.0`, `busybox:1.2/lib@1.1.0`)',
      done: false,
      params: { 'location-id': 'busybox/lib' },
    },
    {
      type: 'task',
      label: 'other',
      done: true,
      params: { 'location-id': 'other', 'auto-done': 'true' },
    },
  ])
})

const exampleVulnerability: Vulnerability = {
  id: '123',
  vulnerabilityID: 'CVE-0',
  severity: 'CRITICAL',
  cvssNvdV3Vector: 'CVSS:3.1',
  cvssNvdV3Score: 10,
  title: 'Title',
  description: 'Description',
  locations: [
    {
      id: 'alpine/lib',
      artifactNameShort: 'alpine',
      packageName: 'lib',
      versions: [
        {
          artifactVersion: '3.15',
          installedVersion: '1.0.0',
          fixedVersion: '1.2.0',
        },
        {
          artifactVersion: '3.16',
          installedVersion: '1.1.0',
          fixedVersion: '1.2.0',
        },
      ],
    },
    {
      id: 'busybox/lib',
      artifactNameShort: 'busybox',
      packageName: 'lib',
      versions: [
        {
          artifactVersion: '1.1',
          installedVersion: '1.0.0',
          fixedVersion: '1.2.0',
        },
        {
          artifactVersion: '1.2',
          installedVersion: '1.1.0',
          fixedVersion: '1.2.0',
        },
      ],
    },
  ],
  references: ['https://link1', 'https://link2'],
}
