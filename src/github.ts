import { Octokit, RestEndpointMethodTypes } from '@octokit/action'
import { ArrayElement } from './utils'

export type GithubIssue = ArrayElement<RestEndpointMethodTypes['issues']['listForRepo']['response']['data']>
export type GithubIssueTemplate = Pick<GithubIssue, 'title' | 'body' | 'labels' | 'state'>

export async function listAllGithubRepoIssuesByLabels(
  octokit: InstanceType<typeof Octokit>,
  owner: string,
  repo: string,
  filter?: { state?: 'open' | 'closed' | 'all'; labels?: string }
): Promise<GithubIssue[]> {
  const perPage = 100
  const issues: GithubIssue[] = []
  for (let page = 1; true; page++) {
    const issuesForPage = await octokit.issues
      .listForRepo({
        owner,
        repo,
        per_page: perPage,
        page,
        sort: 'created',
        state: filter?.state,
        labels: filter?.labels,
      })
      .then(res => res.data)
    issues.push(...issuesForPage)
    if (issuesForPage.length < perPage) {
      break
    }
  }
  return issues
}
